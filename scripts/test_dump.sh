#!/bin/bash
set -eu
set -x

if [[ ! -f 'scripts/libmeta.rar' || ! -f 'scripts/fiction.rar' || ! -f 'scripts/libmeta_compact.rar' || "${1:-}" == '-f' ]]; then

  LIBMETA_MD5S=" (
'A14888D5DA7465A06BA13A19340314C1', '7b2a4d53fde834e801c26a2bab7e0240',
'ff76851e269519fd653beb5907048db2', 'd63aa15ab0a797dbd851ae5f6f647611',
'21227d849cdb714f136127c0ba15d62c', '3e9400aa7c4c99881ed7eda013a27c0e',
'87F1BA0879A4F5E6F2B1B4B96059113F', '1FB624978D9B4598C6B7E8E948230FFA',
'6F1C3F3037903FEB90F1CCDD621DB8FC', '342645e3721601a3f6c1b3c1dd9294f0',
'2de093156c27ffaddaf5bea8f8a7c1ce', 'f9eaa571ac7f33a9308f89279b8e0635',
'263a79949abfd9c4bb4e64f65d202812', '2ab25a344f2a56b9038e7a149634c9cf',
'B432977C9A5B2C18DD0DCE8B5AB58AE6'
)"
  FICTION_MD5S="(
'3CB8F86B2C7157F9F6070A567642A82C', '8AB3891CDB568FEF5D4CD0ADDAEB7103', '9D2139EB21303184BD7A4CDFD4BB28A0',
'435B4156E953952C9F3CE02A3BA360FA', '3B602343D78164FD2B01034413C34944', 'B56578AB4AA9C84D1030D2CFC615D83F',
'6509C2EB6C5548EEE970EA35B005EF31', '480002ED2E151174F59A3F97A3F0DB6C', '7857972B1D45E9ED4AA579769FA0C087',
'83FF4E879E6CE61BFB869726DA2ADF0C', '406415A0E69E1D3EC35CE5962D526D8F', '919F87A305EAB22698EF05FF3DB23304',
'25A07843BD77E1F12DEA69E5F38146FE', '48A41F13813239E3D944A6DD992BB18E', '09037A2C067D6D8A220BDEC054E4AC4E',
'E7D287D60FB5C0445A0BE7057E55C2E0', 'F28D0723BD97B7C5D1F29F374F681543', 'A40A6D29CBCAD9C849132DDB7B3533F7',
'B31A4407B0C729C0C8200EE49845ADA6', '84480FAF9446D1486507F88B5816F302', '7BC57ED8B03BF47AC02CD94B11F54A7D',
'8289DE6787434AA4F150BEAE10BC8D5C', 'DBC4A3098CD8EB9114A77F0AD5B920DA', '02FF73E69AC05143F946D11D791FB338',
'963FEFB27FD738688AFE7548765BEB1B', '82773EE6BBF75019C1ABC2B82136040B', 'AAA5505B267053A3F440AF9D24B24B09',
'33C33BB3C2DFEEFF8D6A4B079E67EBF0', 'B67650C3FD9F85F69B76FA95720ECBB8', '5436BDE38EA30B80046064661A0B0A48',
'B1CCCF89609904137963DF6FC7BDEBAD', '403506A37BA5693EA843219A896FF73A', '84F8FEC64B1B387315BFBE575855EE34',
'97AD0D35FD5B6646082DB142C97A454B', '799B9DCBC5512BBCBA4092A314A1463A', '59F3F3F2BD5B7CC1A797019B9A8B548C',
'5A365AB52EDB9530EE62FE11E4203DF3', 'BF8DFC8AD2C0021BE2AFEB9FEF19539C', 'BA4DA2B71DE18FB8DA1B89FFC622CE29',
'39648D647BA9425FDE13EA44106AA1D8', '389B34278BD7B63BA0C9BF74D75588FD', '5B4A9E0217C308C7A5E7F8EC3B6B5865',
'3B4683E5091D638F17B04EA64CB98C9E', '16E864FDF3E3C1A529F8A396D9A2BE04', 'E6C9F6969FA6127DA7EBDDEE66E678E9',
'D690B4E44C11EB218442D9B24070CCB4', '1251EF105017ABEE9AD645E0D8726CF6', '98AF5637B794695C200C63B2CEDA5324',
'F7EA2AAF1303AA3185E954A8B31F1803', 'A51DE1B4C1E9D38B8B3564A96D18F2B8', 'B4EFF3D13945DB8C6F29FD8F0D66394F',
'F47C627F70705FDFC7F9DC06146493D2', '5D56659EE35CFB7E26DAC70EE5354910', '32CFCEEF9C27CC8658DEEAA9A7BD47E6',
'519BA0CC3A4F7B83038CFC2E6388652C', 'F26EC6AB598522C7483A05880695DC5D', 'BCBD6A98579D9073A43B85C18457EE46',
'C320198B9566120121D08E174F195D3C', '075E8C502B7E430414B62B6557904F9B', '7618E4373A3F8E466427B8EC9412CB6F'
)"

  DUMP="mysqldump --password=$(cat secrets/db-password.txt) --complete-insert libmeta"

  $DUMP updated --where="MD5 in $LIBMETA_MD5S" > /tmp/libmeta.sql
  $DUMP description --where="MD5 in $LIBMETA_MD5S" >> /tmp/libmeta.sql

  $DUMP fiction --where="MD5 in $FICTION_MD5S" > /tmp/fiction.sql
  $DUMP fiction_description --where="MD5 in $FICTION_MD5S" >> /tmp/fiction.sql

  cp /tmp/libmeta.sql /tmp/libmeta_compact.sql

  for db in fiction libmeta libmeta_compact; do
    rm /tmp/${db}.rar 2>/dev/null || true
    rar -idq a -ep /tmp/${db}.rar /tmp/${db}.sql
    cp /tmp/${db}.rar scripts/
  done
fi

DEST_DIR=${DUMP_DIR:-dumps}

for db in fiction libmeta libmeta_compact; do
  rm $DEST_DIR/${db}/* 2>/dev/null || true
  mkdir -p $DEST_DIR/${db}/
  cp scripts/${db}.rar $DEST_DIR/${db}/
done

